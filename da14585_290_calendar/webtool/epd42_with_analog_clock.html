<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>ç”µå­ä»·ç­¾è“ç‰™æ§åˆ¶å™¨-SES4.2 (å¸¦æ¨¡æ‹Ÿæ—¶é’Ÿæ—¥å†åŠŸèƒ½)</title>
	<style>
		#tool-box>* {
			margin-right: 5px;
		}
		* {
			padding: 0;
			margin: 0;
		}
		button,a {
			padding: 2px;
			margin: 2px;
			display: inline-block;
		}
		body {
			padding: 20px;
			overflow-y: auto;
		}
		.display-mode-section {
			background-color: #f0f0f0;
			padding: 10px;
			margin: 10px 0;
			border-radius: 5px;
		}
		.display-mode-section h4 {
			margin-bottom: 10px;
			color: #333;
		}
		.mode-button {
			background-color: #4CAF50;
			color: white;
			border: none;
			padding: 8px 16px;
			margin: 4px;
			border-radius: 4px;
			cursor: pointer;
		}
		.mode-button:hover {
			background-color: #45a049;
		}
		.analog-clock-section {
			background-color: #e8f4f8;
			padding: 10px;
			margin: 10px 0;
			border-radius: 5px;
			border-left: 4px solid #2196F3;
		}
	</style>
	<script type="application/javascript" src="js/dithering.js"></script>
	<script type="application/javascript" src="js/utils.js"></script>
</head>

<body>
	<script>
		let bleDevice;
		let gattServer;
		let epdService;
		let rxtxService;
		let epdCharacteristic;
		let rxtxCharacteristic;
		let reconnectTrys = 0;
		const my_step = 900;

		function delay(delayInms) {
		  return new Promise(resolve => {
			setTimeout(() => {
			  resolve(2);
			}, delayInms);
		  });
		}

		function resetVariables() {
			gattServer = null;
			epdService = null;
			epdCharacteristic = null;
			rxtxCharacteristic = null;
			rxtxService = null;
			document.getElementById("log").value = '';
		}

		async function handleError(error) {
			console.log(error);
			resetVariables();
			if (bleDevice == null)
				return;
			if (reconnectTrys <= 5) {
				reconnectTrys++;
				await connect();
			}
			else {
				addLog("Was not able to connect, aborting");
				reconnectTrys = 0;
			}
		}

		async function sendCommand(cmd) {
			if (epdCharacteristic) {
				await epdCharacteristic.writeValueWithResponse(cmd)
			} else {
				addLog('æœåŠ¡ä¸å¯ç”¨ã€‚è“ç‰™é“¾æ¥ä¸Šäº†å—ï¼Ÿ')
			}
		}

		async function rxTxSendCommand(cmd) {
		  if (rxtxCharacteristic) {
			await rxtxCharacteristic.writeValueWithResponse(cmd);
		  } else {
			  addLog('æœåŠ¡ä¸å¯ç”¨ã€‚è“ç‰™é“¾æ¥ä¸Šäº†å—ï¼Ÿ')
		  }
		}

		async function setTime() {
			const { unixNow, localeTimeString, year, month, day, week } = getUnixTime();

		  	addLog("æ—¶é—´è®¾ç½®ä¸º: " + localeTimeString + " : dd" + intToHex(unixNow, 4));
		  	await rxTxSendCommand(hexToBytes('dd' +
					[intToHex(unixNow, 4), intToHex(year, 2), intToHex(month, 1), intToHex(day, 1), intToHex(week, 1)].join('')));

			await rxTxSendCommand(hexToBytes('e2'))
		}

		// åˆ‡æ¢åˆ°æ—¶é—´æ˜¾ç¤ºæ¨¡å¼
		async function switchToTimeMode() {
			addLog('åˆ‡æ¢åˆ°æ—¶é—´æ˜¾ç¤ºæ¨¡å¼');
			await rxTxSendCommand(hexToBytes('e3'));
		}

		// åˆ‡æ¢åˆ°æ—¥å†æ˜¾ç¤ºæ¨¡å¼ï¼ˆæ•°å­—æ—¶é’Ÿï¼‰
		async function switchToCalendarMode() {
			addLog('åˆ‡æ¢åˆ°æ—¥å†æ˜¾ç¤ºæ¨¡å¼ï¼ˆæ•°å­—æ—¶é’Ÿï¼‰');
			await rxTxSendCommand(hexToBytes('e4'));
		}

		// æ–°å¢ï¼šåˆ‡æ¢åˆ°æ—¥å†æ˜¾ç¤ºæ¨¡å¼ï¼ˆæ¨¡æ‹Ÿæ—¶é’Ÿï¼‰
		async function switchToCalendarAnalogMode() {
			addLog('åˆ‡æ¢åˆ°æ—¥å†æ˜¾ç¤ºæ¨¡å¼ï¼ˆæ¨¡æ‹Ÿæ—¶é’Ÿï¼‰');
			await rxTxSendCommand(hexToBytes('e5'));
		}

		async function triggerRxTxCmd(cmd) {
			addLog(`å‘é€æŒ‡ä»¤: ${cmd}`)
			await rxTxSendCommand(hexToBytes(cmd));
		}

		async function triggerEpdCmd(cmd) {
			addLog(`å‘é€æŒ‡ä»¤: ${cmd}`)
			await sendCommand(hexToBytes(cmd));
		}

		function disconnect() {
			resetVariables();
			addLog('é“¾æ¥å·²æ–­å¼€.');
			document.getElementById("connectbutton").innerHTML = 'é“¾æ¥';
		}

		async function preConnect() {
			if (gattServer != null && gattServer.connected) {
				if (bleDevice != null && bleDevice.gatt.connected)
					bleDevice.gatt.disconnect();
			}
			else {
				reconnectTrys = 0;
				bleDevice = await navigator.bluetooth.requestDevice({ optionalServices: ['0000221f-0000-1000-8000-00805f9b34fb', '00001f10-0000-1000-8000-00805f9b34fb', '13187b10-eba9-a3ba-044e-83d3217d9a38'], acceptAllDevices: true });
				await bleDevice.addEventListener('gattserverdisconnected', disconnect);
				try {
					await connect();
				} catch (e) {
					await handleError(e);
				}
			}
		}

		async function connectRXTX() {
			rxtxService = await gattServer.getPrimaryService('00001f10-0000-1000-8000-00805f9b34fb');
			addLog('> rxtxService æ‰¾åˆ°ä¸²å£æœåŠ¡');

			rxtxCharacteristic = await rxtxService.getCharacteristic('00001f1f-0000-1000-8000-00805f9b34fb');
			addLog('> rxtxCharacteristic ä¸²å£æœåŠ¡å·²é“¾æ¥');
		}

		async function connect() {
			if (epdCharacteristic == null) {
				addLog("æ­£åœ¨é“¾æ¥: " + bleDevice.name);

				gattServer = await bleDevice.gatt.connect();
				addLog('> æ‰¾åˆ°GATTæœåŠ¡å™¨');

				epdService = await gattServer.getPrimaryService('13187b10-eba9-a3ba-044e-83d3217d9a38');
				addLog('>  epdService æ‰¾åˆ°å¯ç”¨æœåŠ¡');

				epdCharacteristic = await epdService.getCharacteristic('4b646063-6264-f3a7-8941-e65356ea82fe');
				addLog('> epdCharacteristic æœåŠ¡å·²è¿æ¥');

				await epdCharacteristic.startNotifications();

				epdCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
					console.log('epd ret', bytesToHex(event.target.value.buffer))
					const count = parseInt('0x'+ bytesToHex(event.target.value.buffer));
					
					addLog(`> [æ¥è‡ªå±å¹•]: æ”¶åˆ°${count} byteæ•°æ®`);
				});

				document.getElementById("connectbutton").innerHTML = 'æ–­å¼€';
				await connectRXTX();
			}
		}

		function addLog(logTXT) {
			const today = new Date();
			const time = ("0" + today.getHours()).slice(-2) + ":" + ("0" + today.getMinutes()).slice(-2) + ":" + ("0" + today.getSeconds()).slice(-2) + " : ";

			const dom = document.getElementById("log");

			dom.innerHTML += time + logTXT + '<br>';
			dom.scrollTop = dom.scrollHeight;
		}

		function getUnixTime() {
			const hourOffset = document.getElementById('hour-offset').value;
		  	const unixNow = Math.round(Date.now() / 1000)+(60*60*hourOffset)  - new Date().getTimezoneOffset() * 60;

			const date = new Date((unixNow + new Date().getTimezoneOffset() * 60)*1000);
		  	const localeTimeString = date.toLocaleTimeString();

			return {unixNow, localeTimeString, year: date.getFullYear(), month: date.getMonth() + 1, day: date.getDate(), week: date.getDay() || 7}
		}

		document.body.onload = () => {
			setInterval(() => {
				const { localeTimeString, year, month, day, week } = getUnixTime();
				document.getElementById('time-setter').innerText = `è®¾ç½®æ—¶é—´ä¸ºï¼š${year}-${month}-${day} ${localeTimeString} æ˜ŸæœŸ${week}`;
			}, 1000);
		}
	</script>
	
	<h2>ç”µå­ä»·ç­¾è“ç‰™æ§åˆ¶å™¨-SES4.2 (å¸¦æ¨¡æ‹Ÿæ—¶é’Ÿæ—¥å†åŠŸèƒ½)</h2>

	<button id="connectbutton" type="button" onclick="preConnect();">é“¾æ¥</button>
	<button type="button" onclick="document.getElementById('log').innerHTML = '';">æ¸…ç©ºæ—¥å¿—</button>
	<br><br>

	<div class="display-mode-section">
		<h4>æ˜¾ç¤ºæ¨¡å¼æ§åˆ¶</h4>
		<button class="mode-button" type="button" onclick="switchToTimeMode()" title="åˆ‡æ¢åˆ°æ—¶é—´æ˜¾ç¤ºæ¨¡å¼">æ—¶é—´æ¨¡å¼</button>
		<button class="mode-button" type="button" onclick="switchToCalendarMode()" title="åˆ‡æ¢åˆ°æ—¥å†æ˜¾ç¤ºæ¨¡å¼ï¼ˆæ•°å­—æ—¶é’Ÿï¼‰">æ—¥å†æ¨¡å¼ï¼ˆæ•°å­—ï¼‰</button>
		<button class="mode-button" type="button" onclick="switchToCalendarAnalogMode()" title="åˆ‡æ¢åˆ°æ—¥å†æ˜¾ç¤ºæ¨¡å¼ï¼ˆæ¨¡æ‹Ÿæ—¶é’Ÿï¼‰">æ—¥å†æ¨¡å¼ï¼ˆæ¨¡æ‹Ÿï¼‰</button>
		<button type="button" onclick="triggerRxTxCmd('e2')" title="åˆ·æ–°å½“å‰æ˜¾ç¤º">åˆ·æ–°æ˜¾ç¤º</button>
	</div>

	<div class="analog-clock-section">
		<h4>ğŸ• æ¨¡æ‹Ÿæ—¶é’ŸåŠŸèƒ½è¯´æ˜</h4>
		<p><strong>æ—¥å†æ¨¡å¼ï¼ˆæ¨¡æ‹Ÿï¼‰</strong>ï¼šåœ¨æ—¥å†å³ä¾§æ˜¾ç¤º120x120åƒç´ çš„æ¨¡æ‹Ÿæ—¶é’Ÿ</p>
		<ul>
			<li>âœ… æ˜¾ç¤º12å°æ—¶æ•°å­—å’Œåˆ»åº¦ç‚¹</li>
			<li>âœ… æ—¶é’ˆå’Œåˆ†é’ˆå®æ—¶æŒ‡ç¤ºå½“å‰æ—¶é—´</li>
			<li>âœ… æ™ºèƒ½åˆ·æ–°ï¼šæ•°å­—å’Œåˆ»åº¦åœ¨åˆå§‹åŒ–æˆ–æ•´ç‚¹æ—¶é‡ç»˜ï¼ŒæŒ‡é’ˆæ¯åˆ†é’Ÿå±€éƒ¨åˆ·æ–°</li>
			<li>âœ… å°è£…è®¾è®¡ï¼šå¯è½»æ¾è°ƒæ•´å¤§å°å’Œä½ç½®ï¼Œé€‚é…ä¸åŒå±å¹•å°ºå¯¸</li>
		</ul>
		<p><em>æ³¨æ„ï¼šæ¨¡æ‹Ÿæ—¶é’ŸåŠŸèƒ½éœ€è¦å›ºä»¶æ”¯æŒï¼Œè¯·ç¡®ä¿å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬</em></p>
	</div>

	<h3>æ—¶é—´è®¾ç½®</h3>
	æ—¶åŒºåç§»: <input type="number" id="hour-offset" value="8" min="-12" max="12" step="1"> å°æ—¶<br>
	<span id="time-setter">è®¾ç½®æ—¶é—´ä¸ºï¼š</span><br>
	<button type="button" onclick="setTime()">è®¾ç½®æ—¶é—´</button>
	<br><br>

	<h3>æŒ‡ä»¤æ§åˆ¶</h3>
	<input type="text" id="cmdTXT" value="0055">
	<button type="button" onclick="triggerEpdCmd(document.getElementById(&quot;cmdTXT&quot;).value);">å‘é€æŒ‡ä»¤</button>
	<br>
	<button type="button" onclick="triggerRxTxCmd('e100')" title="ç‚¹å‡»è¯¥æŒ‰é’®ï¼Œç„¶åä¸Šä¼ å›¾ç‰‡ã€‚å›¾ç‰‡å°†æ°¸ä¹…æ˜¾ç¤ºåˆ°å±å¹•ä¸Š">è®¾ç½®ä¸ºå›¾ç‰‡æ¨¡å¼</button>
	<button type="button" onclick="triggerRxTxCmd('00')" title="ç‚¹å‡»è¯¥æŒ‰é’®, åˆ‡æ¢ä¸ºæ—¶é’Ÿæ¨¡å¼">åˆ·æ–°</button>
	<br><br>

	<h3>æŒ‡ä»¤è¯´æ˜</h3>
	<table border="1" style="border-collapse: collapse; margin: 10px 0;">
		<tr>
			<th style="padding: 5px;">æŒ‡ä»¤</th>
			<th style="padding: 5px;">åŠŸèƒ½</th>
		</tr>
		<tr>
			<td style="padding: 5px;">0xE2</td>
			<td style="padding: 5px;">åˆ·æ–°å½“å‰æ˜¾ç¤º</td>
		</tr>
		<tr>
			<td style="padding: 5px;">0xE3</td>
			<td style="padding: 5px;">åˆ‡æ¢åˆ°æ—¶é—´æ˜¾ç¤ºæ¨¡å¼</td>
		</tr>
		<tr>
			<td style="padding: 5px;">0xE4</td>
			<td style="padding: 5px;">åˆ‡æ¢åˆ°æ—¥å†æ¨¡å¼ï¼ˆæ•°å­—æ—¶é’Ÿï¼‰</td>
		</tr>
		<tr style="background-color: #e8f4f8;">
			<td style="padding: 5px;"><strong>0xE5</strong></td>
			<td style="padding: 5px;"><strong>åˆ‡æ¢åˆ°æ—¥å†æ¨¡å¼ï¼ˆæ¨¡æ‹Ÿæ—¶é’Ÿï¼‰</strong></td>
		</tr>
	</table>

	<h3>æ—¥å¿—è¾“å‡º</h3>
	<div id="log" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9;"></div>

</body>
</html>

