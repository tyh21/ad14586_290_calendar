<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>电子价签蓝牙控制器-SES4.2 (带日历功能)</title>
	<style>
		#tool-box>* {
			margin-right: 5px;
		}
		* {
			padding: 0;
			margin: 0;
		}
		button,a {
			padding: 2px;
			margin: 2px;
			display: inline-block;
		}
		body {
			padding: 20px;
			overflow-y: hidden;
		}
		.display-mode-section {
			background-color: #f0f0f0;
			padding: 10px;
			margin: 10px 0;
			border-radius: 5px;
		}
		.display-mode-section h4 {
			margin-bottom: 10px;
			color: #333;
		}
	</style>
	<script type="application/javascript" src="js/dithering.js"></script>
	<script type="application/javascript" src="js/utils.js"></script>
</head>

<body>
	<script>
		let bleDevice;
		let gattServer;
		let epdService;
		let rxtxService;
		let epdCharacteristic;
		let rxtxCharacteristic;
		let reconnectTrys = 0;
		const my_step = 900;

		function delay(delayInms) {
		  return new Promise(resolve => {
			setTimeout(() => {
			  resolve(2);
			}, delayInms);
		  });
		}

		function resetVariables() {
			gattServer = null;
			epdService = null;
			epdCharacteristic = null;
			rxtxCharacteristic = null;
			rxtxService = null;
			document.getElementById("log").value = '';
		}

		async function handleError(error) {
			console.log(error);
			resetVariables();
			if (bleDevice == null)
				return;
			if (reconnectTrys <= 5) {
				reconnectTrys++;
				await connect();
			}
			else {
				addLog("Was not able to connect, aborting");
				reconnectTrys = 0;
			}
		}

		async function sendCommand(cmd) {
			if (epdCharacteristic) {
				await epdCharacteristic.writeValueWithResponse(cmd)
			} else {
				addLog('服务不可用。蓝牙链接上了吗？')
			}
		}

		async function rxTxSendCommand(cmd) {
		  if (rxtxCharacteristic) {
			await rxtxCharacteristic.writeValueWithResponse(cmd);
		  } else {
			  addLog('服务不可用。蓝牙链接上了吗？')
		  }
		}

		async function setTime() {
			const { unixNow, localeTimeString, year, month, day, week } = getUnixTime();

		  	addLog("时间设置为: " + localeTimeString + " : dd" + intToHex(unixNow, 4));
		  	await rxTxSendCommand(hexToBytes('dd' +
					[intToHex(unixNow, 4), intToHex(year, 2), intToHex(month, 1), intToHex(day, 1), intToHex(week, 1)].join('')));

			await rxTxSendCommand(hexToBytes('e2'))
		}

		// 新增：切换到时间显示模式
		async function switchToTimeMode() {
			addLog('切换到时间显示模式');
			await rxTxSendCommand(hexToBytes('e3'));
		}

		// 新增：切换到日历显示模式
		async function switchToCalendarMode() {
			addLog('切换到日历显示模式');
			await rxTxSendCommand(hexToBytes('e4'));
		}

		async function triggerRxTxCmd(cmd) {
			addLog(`发送指令: ${cmd}`)
			await rxTxSendCommand(hexToBytes(cmd));
		}

		async function triggerEpdCmd(cmd) {
			addLog(`发送指令: ${cmd}`)
			await sendCommand(hexToBytes(cmd));
		}

		function disconnect() {
			resetVariables();
			addLog('链接已断开.');
			document.getElementById("connectbutton").innerHTML = '链接';
		}

		async function preConnect() {
			if (gattServer != null && gattServer.connected) {
				if (bleDevice != null && bleDevice.gatt.connected)
					bleDevice.gatt.disconnect();
			}
			else {
				reconnectTrys = 0;
				bleDevice = await navigator.bluetooth.requestDevice({ optionalServices: ['0000221f-0000-1000-8000-00805f9b34fb', '00001f10-0000-1000-8000-00805f9b34fb', '13187b10-eba9-a3ba-044e-83d3217d9a38'], acceptAllDevices: true });
				await bleDevice.addEventListener('gattserverdisconnected', disconnect);
				try {
					await connect();
				} catch (e) {
					await handleError(e);
				}
			}
		}

		async function connectRXTX() {
			rxtxService = await gattServer.getPrimaryService('00001f10-0000-1000-8000-00805f9b34fb');
			addLog('> rxtxService 找到串口服务');

			rxtxCharacteristic = await rxtxService.getCharacteristic('00001f1f-0000-1000-8000-00805f9b34fb');
			addLog('> rxtxCharacteristic 串口服务已链接');
		}

		async function connect() {
			if (epdCharacteristic == null) {
				addLog("正在链接: " + bleDevice.name);

				gattServer = await bleDevice.gatt.connect();
				addLog('> 找到GATT服务器');

				epdService = await gattServer.getPrimaryService('13187b10-eba9-a3ba-044e-83d3217d9a38');
				addLog('>  epdService 找到可用服务');

				epdCharacteristic = await epdService.getCharacteristic('4b646063-6264-f3a7-8941-e65356ea82fe');
				addLog('> epdCharacteristic 服务已连接');

				await epdCharacteristic.startNotifications();

				epdCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
					console.log('epd ret', bytesToHex(event.target.value.buffer))
					const count = parseInt('0x'+ bytesToHex(event.target.value.buffer));
					
					addLog(`> [来自屏幕]: 收到${count} byte数据`);
				});

				document.getElementById("connectbutton").innerHTML = '断开';
				await connectRXTX();
			}
		}

		function addLog(logTXT) {
			const today = new Date();
			const time = ("0" + today.getHours()).slice(-2) + ":" + ("0" + today.getMinutes()).slice(-2) + ":" + ("0" + today.getSeconds()).slice(-2) + " : ";

			const dom = document.getElementById("log");

			dom.innerHTML += time + logTXT + '<br>';
			dom.scrollTop = dom.scrollHeight;
		}

		function getUnixTime() {
			const hourOffset = document.getElementById('hour-offset').value;
		  	const unixNow = Math.round(Date.now() / 1000)+(60*60*hourOffset)  - new Date().getTimezoneOffset() * 60;

			const date = new Date((unixNow + new Date().getTimezoneOffset() * 60)*1000);
		  	const localeTimeString = date.toLocaleTimeString();

			return {unixNow, localeTimeString, year: date.getFullYear(), month: date.getMonth() + 1, day: date.getDate(), week: date.getDay() || 7}
		}

		document.body.onload = () => {
			setInterval(() => {
				const { localeTimeString, year, month, day, week } = getUnixTime();
				document.getElementById('time-setter').innerText = `设置时间为：${year}-${month}-${day} ${localeTimeString} 星期${week}`;
			}, 1000);
		}
	</script>
	
	<h2>电子价签蓝牙控制器-SES4.2 (带日历功能)</h2>

	<button id="connectbutton" type="button" onclick="preConnect();">链接</button>
	<button type="button" onclick="document.getElementById('log').innerHTML = '';">清空日志</button>
	<br><br>

	<div class="display-mode-section">
		<h4>显示模式控制</h4>
		<button type="button" onclick="switchToTimeMode()" title="切换到时间显示模式">时间模式</button>
		<button type="button" onclick="switchToCalendarMode()" title="切换到日历显示模式">日历模式</button>
		<button type="button" onclick="triggerRxTxCmd('e2')" title="刷新当前显示">刷新显示</button>
	</div>

	<h3>时间设置</h3>
	时区偏移: <input type="number" id="hour-offset" value="8" min="-12" max="12" step="1"> 小时<br>
	<span id="time-setter">设置时间为：</span><br>
	<button type="button" onclick="setTime()">设置时间</button>
	<br><br>

	<h3>指令控制</h3>
	<input type="text" id="cmdTXT" value="0055">
	<button type="button" onclick="triggerEpdCmd(document.getElementById(&quot;cmdTXT&quot;).value);">发送指令</button>
	<br>
	<button type="button" onclick="triggerRxTxCmd('e100')" title="点击该按钮，然后上传图片。图片将永久显示到屏幕上">设置为图片模式</button>
	<button type="button" onclick="triggerRxTxCmd('00')" title="点击该按钮, 切换为时钟模式">刷新</button>
	<br><br>

	<h3>日志输出</h3>
	<div id="log" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9;"></div>

</body>
</html>

